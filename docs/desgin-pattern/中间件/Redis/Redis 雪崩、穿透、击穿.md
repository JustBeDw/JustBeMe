# Redis 雪崩、穿透、击穿

## Redis——雪崩

某一时间大量的Key失效，并且大量的用户涌入，造成`缓存雪崩`。此时的所有请求都打到了数据库中，然后数据库扛不住这么多的访问，崩了。即使重启数据库，又会有大量的请求落在数据库中，还是崩了。

#### 如何应对 Redis雪崩

既然是大量Key同一时间失效，那么就将失效时间随机，`setJedis(key , value,time + Random()*1000);`；或者设置Key 用不失效，如果有更新操作，就更新缓存。

可以部署集群，将热点数据分配到不同的Redis中。

## Redis——穿透

数据库的数据库会在缓存中有一份，用户查询某个数据，先查询缓存，如果缓存没有，再从数据库中查找。但数据库也没有，大量的访问数据库操作就会造成数据库的崩溃，因为缓存此时是透明的，就造成了redis穿透。

#### 如何应对Redis穿透

造成Redis穿透，很有可能是攻击者故意造成的。  
**例如：** `id`是从 **1** 开始的，攻击者则要查询 **id = -1**的数据，这在数据库和缓存中是没有的。大量的请求使得数据库崩溃。  
**应对策略：**

1. 做基础校验；对id值进行校验，如果 id < 1 则进行拦截。
2. 如果访问的数据不存在可以返回一个null -> `setnx key null`。
3. `布隆过滤器`：其原理是用hash快速判断key是否存在，不存在就返回，存在刷新K， V。

<a href= "https://github.com/AobingJava/JavaFamily/blob/master/docs/redis/布隆过滤器(BloomFilter).md">布隆过滤器的介绍</a>

## Redis——击穿

一个Key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个Key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库。

#### 如何应对Redis击穿

一个用户不可能在每秒访问数百次以上，所以可以在网关层，检验一个IP每秒访问次数超过阈值，直接小黑屋。  
或者设计Key不过期。